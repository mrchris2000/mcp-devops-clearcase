"use strict";var me=Object.create;var D=Object.defineProperty;var ge=Object.getOwnPropertyDescriptor;var fe=Object.getOwnPropertyNames,B=Object.getOwnPropertySymbols,ve=Object.getPrototypeOf,L=Object.prototype.hasOwnProperty,we=Object.prototype.propertyIsEnumerable;var J=(c,t,e)=>t in c?D(c,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):c[t]=e,W=(c,t)=>{for(var e in t||={})L.call(t,e)&&J(c,e,t[e]);if(B)for(var e of B(t))we.call(t,e)&&J(c,e,t[e]);return c};var Re=(c,t)=>{for(var e in t)D(c,e,{get:t[e],enumerable:!0})},Y=(c,t,e,s)=>{if(t&&typeof t=="object"||typeof t=="function")for(let o of fe(t))!L.call(c,o)&&o!==e&&D(c,o,{get:()=>t[o],enumerable:!(s=ge(t,o))||s.enumerable});return c};var b=(c,t,e)=>(e=c!=null?me(ve(c)):{},Y(t||!c||!c.__esModule?D(e,"default",{value:c,enumerable:!0}):e,c)),Se=c=>Y(D({},"__esModule",{value:!0}),c);var n=(c,t,e)=>new Promise((s,o)=>{var r=l=>{try{u(e.next(l))}catch(h){o(h)}},a=l=>{try{u(e.throw(l))}catch(h){o(h)}},u=l=>l.done?s(l.value):Promise.resolve(l.value).then(r,a);u((e=e.apply(c,t)).next())});var Pe={};Re(Pe,{activate:()=>ke,deactivate:()=>ye});module.exports=Se(Pe);var k=b(require("vscode"));var i=b(require("vscode")),Z=require("path"),j=require("child_process");var d=b(require("vscode"));var Ee=b(require("vscode"));var $="ideintegration.exe",Q="ideintegration";var U,T,y;function z(){U=d.window.createStatusBarItem(d.StatusBarAlignment.Left,2),U.tooltip="Version info of current element",T=d.window.createStatusBarItem(d.StatusBarAlignment.Left,1),T.tooltip="Click for Full History",y=d.window.createStatusBarItem(d.StatusBarAlignment.Left,0),y.command="cc.describe",y.tooltip="Refresh File Status",U.show(),T.show(),y.show()}function q(){y.hide(),T.hide(),U.hide()}function V(c,t,e){let s;switch(c){case 0:s=U.text,U.text="$(repo-sync~spin) "+t+"...";break;case 1:s=T.text,T.text="$(repo-sync~spin) "+t+"...";break;case 2:s=y.text,y.text="$(repo-sync~spin) "+t+"...";break;default:break}let o={location:d.ProgressLocation.Notification,title:t,cancellable:!1};e&&d.window.withProgress(o,(r,a)=>{var u=new Promise(l=>{});return u})}function P(c){switch(d.commands.executeCommand("setContext","undohijack-criteria",!1),c){case 0:d.commands.executeCommand("setContext","mkelem-criteria",!1),d.commands.executeCommand("setContext","checkin-criteria",!1),d.commands.executeCommand("setContext","checkout-criteria",!0),d.commands.executeCommand("setContext","hijack-criteria",!0);break;case 1:d.commands.executeCommand("setContext","mkelem-criteria",!1),d.commands.executeCommand("setContext","checkin-criteria",!0),d.commands.executeCommand("setContext","checkout-criteria",!1),d.commands.executeCommand("setContext","hijack-criteria",!1);break;case 2:d.commands.executeCommand("setContext","mkelem-criteria",!0),d.commands.executeCommand("setContext","checkin-criteria",!1),d.commands.executeCommand("setContext","checkout-criteria",!1),d.commands.executeCommand("setContext","hijack-criteria",!1);break;case 3:d.commands.executeCommand("setContext","mkelem-criteria",!1),d.commands.executeCommand("setContext","checkin-criteria",!1),d.commands.executeCommand("setContext","checkout-criteria",!0),d.commands.executeCommand("setContext","hijack-criteria",!1),d.commands.executeCommand("setContext","undohijack-criteria",!0);break;case 4:default:d.commands.executeCommand("setContext","mkelem-criteria",!1),d.commands.executeCommand("setContext","checkin-criteria",!1),d.commands.executeCommand("setContext","checkout-criteria",!1),d.commands.executeCommand("setContext","hijack-criteria",!1);break}}var _=b(require("fs"));function K(c){return new Promise((t,e)=>{let s;_.lstat(c,function(o,r){o&&e(o),r.isSymbolicLink()?_.readlink(c,(a,u)=>{t('"'+u+'"')}):t(c.toString())})})}var w=require("vscode");var H=b(require("vscode"));var G=(c,t)=>n(void 0,null,function*(){let e;do e=yield H.window.showInputBox({prompt:c,ignoreFocusOut:!0,title:t});while(!e);return e}),S=c=>n(void 0,null,function*(){return yield H.window.showInputBox({ignoreFocusOut:!0,title:c+" Comment"})}),I=(c,t)=>t!==null?t.map(s=>s.resourceUri.fsPath).includes(c):!1;var x=(c,t)=>{let e=new Array;return t.forEach(s=>{let o={resourcePath:s,comment:c};e.push(o)}),e},E=c=>{let t=new Array;if((c==null?void 0:c.length)===1)try{let e=c[0][0].fsPath;t.push(e)}catch(e){let s=c[0].fsPath;t.push(s)}else(c==null?void 0:c.length)===2&&c[1][0]instanceof H.Uri&&c[1].forEach(e=>{console.log(e);let s=e.fsPath;t.push(s)});return t};var N,C,v,m;var F=class{constructor(t,e){this.stream="";this.viewPath="";this.wanServer="";this.user="";this.apiToken="";this.initSCM=()=>{console.log("Init SCM!!"),N=i.scm.createSourceControl("ClearCase","ClearCase"),C=N.createResourceGroup("CheckedoutResourceGroup","Checked-Out"),v=N.createResourceGroup("HijackResourceGroup","Hijacked"),m=N.createResourceGroup("ViewPrivateResourcesGroup","View-Private")};this.initCommands=()=>{console.log("Init commands!!");let t=i.commands.registerCommand("cc.login",this.loginCmd);this.disposables.push(t);let e=i.commands.registerCommand("cc.logout",this.logout);this.disposables.push(e);let s=i.commands.registerCommand("cc.addView",this.addView);this.disposables.push(s);let o=i.commands.registerCommand("cc.add",this.add);this.disposables.push(o);let r=i.commands.registerCommand("cc.addSelected",this.addSelected);this.disposables.push(r);let a=i.commands.registerCommand("cc.addAll",this.addAll);this.disposables.push(a);let u=i.commands.registerCommand("cc.checkout",this.checkout);this.disposables.push(u);let l=i.commands.registerCommand("cc.checkin",this.checkin);this.disposables.push(l);let h=i.commands.registerCommand("cc.undocheckout",this.undocheckout);this.disposables.push(h);let M=i.commands.registerCommand("cc.hijack",this.hijack);this.disposables.push(M);let A=i.commands.registerCommand("cc.undohijack",this.undohijack);this.disposables.push(A);let O=i.commands.registerCommand("cc.refresh",this.refresh);this.disposables.push(O);let te=i.commands.registerCommand("cc.update",this.update);this.disposables.push(te);let se=i.commands.registerCommand("cc.rename",this.rename);this.disposables.push(se);let oe=i.commands.registerCommand("cc.remove",this.remove);this.disposables.push(oe);let re=i.commands.registerCommand("cc.describe",this.describe);this.disposables.push(re);let ie=i.commands.registerCommand("cc.checkinselected",this.checkInselected);this.disposables.push(ie);let ne=i.commands.registerCommand("cc.checkinall",this.checkInAll);this.disposables.push(ne);let ae=i.commands.registerCommand("cc.undocheckoutselected",this.undocheckoutselected);this.disposables.push(ae);let ce=i.commands.registerCommand("cc.undocheckoutall",this.undocheckoutall);this.disposables.push(ce);let ue=i.commands.registerCommand("cc.undohijackselected",this.undohijackselected);this.disposables.push(ue);let de=i.commands.registerCommand("cc.undohijackall",this.undohijackall);this.disposables.push(de);let le=i.commands.registerCommand("cc.openFile",this.openFile);this.disposables.push(le);let he=i.commands.registerCommand("cc.createactivity",this.createActivityCmd);this.disposables.push(he);let pe=i.commands.registerCommand("cc.setactivity",this.setActivity);this.disposables.push(pe),this.disposables.push(i.window.onDidChangeActiveTextEditor(f=>{console.log("onDidChangeActiveTextEditor"),f&&f.document.uri.toString().startsWith("file:")?(V(2,"Describe"),K(f.document.fileName).then(p=>{this.describeRealFile(p)}).catch(()=>{q()})):(P(4),q())})),this.disposables.push(i.workspace.onWillSaveTextDocument(f=>n(this,null,function*(){console.log("save file="+f.document.uri.fsPath);let p=f.document.uri.fsPath;if(!I(p,m.resourceStates)&&!I(p,C.resourceStates)&&!I(p,v.resourceStates)){let R=yield this.describeRealFile(p);if(R&&R.versionControlled){let Ce=[p];this.checkoutResources(Ce)}}}))),this.disposables.push(i.workspace.onDidCreateFiles(f=>{let p=f.files[0].fsPath;if(console.log("create file="+p),!I(p,m.resourceStates)&&!I(p,C.resourceStates)&&!I(p,v.resourceStates)){let R=[];R.push(p),this.addtoViewPrivateResourceStates(R),this.updateSCMCountBadge()}})),this.disposables.push(i.workspace.onDidDeleteFiles(f=>{console.log("delete files.."),f.files.forEach(R=>console.log(R.fsPath));let p=f.files.map(R=>({resourcePath:R.fsPath,comment:""}));this.filterViewPrivateGroup(p)})),this.disposables.push(i.workspace.onDidChangeConfiguration(f=>{this.wsConfiguraiton=i.workspace.getConfiguration("clearcase")}))};this.updateResourceStatus=()=>n(this,null,function*(){if(console.log("update resource status is invoked!!"),this.viewPath){let t={resourcePath:this.viewPath};try{let e=yield this.invokeAPI("aggregatestatus",t);if(e!==null){let s=e.checkedOutList,o=e.hijackedList,r=e.viewPrivateList;this.updateCheckedOutResourceStates(s),this.updateHijacktResourceStates(o),this.updateViewPrivateResourceStates(r),this.updateSCMCountBadge()}}catch(e){console.warn("Error during getting aggragate resource status!!");let s;throw e.responseMsg?s=e.responseMsg:s=e,console.error("error in updatestatus="+s),e}}});this.updateCheckedOutResourceStates=t=>{if(!t){C.resourceStates=[];return}let e=[];t.forEach(s=>{let o={resourceUri:this.createResourceUri(s)};e.push(o)}),e=[...new Map(e.map(s=>[s.resourceUri.fsPath,s])).values()],C.resourceStates=e};this.updateHijacktResourceStates=t=>{if(!t){v.resourceStates=[];return}let e=[];t.forEach(s=>{let o={resourceUri:this.createResourceUri(s)};e.push(o)}),e=[...new Map(e.map(s=>[s.resourceUri.fsPath,s])).values()],v.resourceStates=e};this.updateViewPrivateResourceStates=t=>{if(!t){m.resourceStates=[];return}let e=[];t.forEach(s=>{let o={resourceUri:this.createResourceUri(s)};e.push(o)}),e=[...new Map(e.map(s=>[s.resourceUri.fsPath,s])).values()],m.resourceStates=e};this.addtoViewPrivateResourceStates=t=>{if(!t)return;let e=m.resourceStates;t.forEach(s=>{let o={resourceUri:this.createResourceUri(s)};e.push(o)}),e=[...new Map(e.map(s=>[s.resourceUri.fsPath,s])).values()],m.resourceStates=e};this.getAuthenticationDetails=(t,e)=>n(this,null,function*(){if(!t&&(t=yield i.window.showInputBox({prompt:"Enter WAN Server URL",ignoreFocusOut:!0}),!t)||!e&&(e=yield i.window.showInputBox({prompt:"Enter User Name",ignoreFocusOut:!0}),!e))return;let s=yield i.window.showInputBox({password:!0,prompt:"Enter Password ("+t+", "+e+")",ignoreFocusOut:!0});return s?{userName:e,password:s,ccrcWanServerURL:t,primaryGroupName:null,groupList:null}:void 0});this.getToken=()=>{if(this.apiToken!=""&&this.apiToken!=null)return{token:this.apiToken}};this.invokeAPI=(t,e)=>n(this,null,function*(){let s;try{let o=this.createRequest(t,this.getToken(),e),r=yield this.sendRequest(JSON.stringify(o));if(s=yield JSON.parse(r),console.log("response="+s),s.responseCode===401)throw s;return s}catch(o){o&&!this.handleTokenInvalidError(o)&&(console.log("API Error= "+o),i.window.showErrorMessage(o))}});this.invokeDescribeFiles=t=>n(this,null,function*(){let e=t.map(s=>s.resourcePath);this.describeRealFiles(e)});this.loginCmd=()=>n(this,null,function*(){this.login(!1)});this.login=(t,e,s)=>n(this,null,function*(){console.log("login is invoked!!");let o=!1,r,a,u=yield this.getAuthenticationDetails(e,s);if(!u)return!1;a=this.createRequest("login",void 0,u),console.log(JSON.stringify(a));let l={location:i.ProgressLocation.Notification,cancellable:!1};if(yield w.window.withProgress(l,(h,M)=>n(this,null,function*(){h.report({message:"Authentication is in progress..."});try{let A=yield this.sendRequest(JSON.stringify(a));console.log(A);let O=JSON.parse(A);if(O.responseCode===200)this.apiToken=O.token,this.updateTokenInRepoCache(),o=!0,i.window.showInformationMessage("Authentication is successfull."),i.commands.executeCommand("setContext","login-criteria",!0);else throw O}catch(A){if(t)return yield this.login(!1,e,s);console.error("Error!! Authentication failed due to "+A),r=A}})),r){let h="";r.responseMsg?h=r.responseMsg:h=r,this.handleTokenInvalidError(r)||(yield i.window.showErrorMessage(`Authentication Failed. 
`+h))}return o});this.logout=()=>n(this,null,function*(){console.log("logout is invoked!!");let t;t=this.createRequest("logout",this.getToken(),void 0);let e=yield this.sendRequest(JSON.stringify(t)),s=JSON.parse(e);s.responseCode===200?(i.commands.executeCommand("setContext","login-criteria",!1),i.window.showInformationMessage("WAN Server is disconnected.")):i.window.showErrorMessage(s.responseMsg)});this.describe=()=>{console.log("describe is invoked"),V(2,"Initialise"),this.describeFile(i.window.activeTextEditor)};this.addView=()=>n(this,null,function*(){let t={canSelectFiles:!1,canSelectFolders:!0,openLabel:"Open View",title:"Open View"};i.window.showOpenDialog(t).then(e=>n(this,null,function*(){if(e&&e[0]){let o=e[0].fsPath;this.setViewPath(o),this.updateTokenInRepoCache();let r=yield i.commands.executeCommand("vscode.openFolder",e[0],!1);console.log("success="+r),r===void 0&&this.globalState.update("isLoginRequired",""),i.window.showInformationMessage("Opened View "+e[0].fsPath)}}))});this.add=(...t)=>n(this,null,function*(){console.log("Add to source control started!!");let e=E(t),s=yield S("Add");if(s===void 0)return;let r={scmResources:x(s,e)};yield this.handleRequest("addtosource",r,"Add to Source is in progress...",0)});this.addSelected=(...t)=>n(this,null,function*(){console.log("Add to Source selected resources is started!!");let e=yield S("Add");if(e===void 0)return;let o={scmResources:t.map(r=>({resourcePath:r.resourceUri.fsPath,comment:e}))};yield this.handleRequest("addtosource",o,"Add to Source is in progress...",0)});this.addAll=t=>n(this,null,function*(){if(console.log("Add All is started!!"),m.resourceStates.length===0)return;let e=yield S("Add");if(e===void 0)return;let o={scmResources:m.resourceStates.map(r=>({resourcePath:r.resourceUri.fsPath,comment:e}))};yield this.handleRequest("addtosource",o,"Add to Source is in progress...",0)});this.checkout=(...t)=>n(this,null,function*(){console.log("Checkout is started!!");let e=E(t);yield this.checkoutResources(e)});this.checkin=(...t)=>n(this,null,function*(){console.log("Check In is started!!");let e=yield S("Check In");if(e===void 0)return;let s=E(t),o=x(e,s),r=this.wsConfiguraiton.get("checkInIdentical");r===void 0&&(r=!1);let a={scmResources:o,checkinIdentical:r};yield this.handleRequest("checkin",a,"Check In is in progress...",2)});this.checkInselected=(...t)=>n(this,null,function*(){console.log("Check In selected resources is started!!");let e=yield S("Check In");if(e===void 0)return;let s=t.map(a=>({resourcePath:a.resourceUri.fsPath,comment:e})),o=this.wsConfiguraiton.get("checkInIdentical");o===void 0&&(o=!1);let r={scmResources:s,checkinIdentical:o};yield this.handleRequest("checkin",r,"Check In is in progress...",2)});this.checkInAll=t=>n(this,null,function*(){if(C.resourceStates.length===0)return;console.log("Check In All is started!!");let e=yield S("Check In");if(e===void 0)return;let s=C.resourceStates.map(a=>({resourcePath:a.resourceUri.fsPath,comment:e})),o=this.wsConfiguraiton.get("checkInIdentical");o===void 0&&(o=!1);let r={scmResources:s,checkinIdentical:o};yield this.handleRequest("checkin",r,"Check In is in progress...",2)});this.undocheckout=(...t)=>n(this,null,function*(){console.log("Undo Checkout is started!!");let e=E(t),s=this.wsConfiguraiton.get("UndoCheckoutKeep");s===void 0&&(s=!1);let o={resourcePaths:e,keep:s};yield this.handleRequest("uncheckout",o,"Undo Checkout is in progress...",3)});this.undocheckoutselected=(...t)=>n(this,null,function*(){console.log("Undo Checkout selected resources is started!!");let e=t.map(r=>r.resourceUri.fsPath),s=this.wsConfiguraiton.get("UndoCheckoutKeep");s===void 0&&(s=!1);let o={resourcePaths:e,keep:s};yield this.handleRequest("uncheckout",o,"Undo Checkout is in progress...",3)});this.undocheckoutall=t=>n(this,null,function*(){if(console.log("Undo Checkout All is started!!"),C.resourceStates.length===0)return;let e=C.resourceStates.map(r=>r.resourceUri.fsPath),s=this.wsConfiguraiton.get("UndoCheckoutKeep");s===void 0&&(s=!1);let o={resourcePaths:e,keep:s};yield this.handleRequest("uncheckout",o,"Undo Checkout is in progress...",3)});this.hijack=(...t)=>n(this,null,function*(){console.log("Hijack is started!!");let s={resourcePaths:E(t)};yield this.handleRequest("hijack",s,"Hijack is in progress...",4)});this.undohijack=(...t)=>n(this,null,function*(){console.log("Undo Hijack is started!!");let e=E(t),s=this.wsConfiguraiton.get("UndoHijackKeep");s===void 0&&(s=!1);let o={resourcePaths:e,keep:s};yield this.handleRequest("unhijack",o,"Undo Hijack is in progress...",5)});this.undohijackselected=(...t)=>n(this,null,function*(){console.log("Undo Hijack selected resources is started!!");let e=t.map(r=>r.resourceUri.fsPath),s=this.wsConfiguraiton.get("UndoHijackKeep");s===void 0&&(s=!1);let o={resourcePaths:e,keep:s};yield this.handleRequest("unhijack",o,"Undo Hijack is in progress...",5)});this.undohijackall=t=>n(this,null,function*(){if(console.log("Undo Hijack All is started!!"),v.resourceStates.length===0)return;let e=v.resourceStates.map(r=>r.resourceUri.fsPath),s=this.wsConfiguraiton.get("UndoHijackKeep");s===void 0&&(s=!1);let o={resourcePaths:e,keep:s};yield this.handleRequest("unhijack",o,"Undo Hijack is in progress...",5)});this.openFile=(...t)=>n(this,null,function*(){let e={preview:!1,viewColumn:i.ViewColumn.Active};t.forEach(s=>{let o=i.Uri.file(s.resourceUri.fsPath);i.commands.executeCommand("vscode.open",o,W({},e))})});this.rename=t=>n(this,null,function*(){console.log("Rename is started!!");let e=yield i.window.showInputBox({prompt:"Enter New Name",ignoreFocusOut:!0,title:"Rename"});if(e){let s={resourcePath:t.fsPath,newName:e};yield this.handleRequest("rename",s,"Rename is in progress...",6)}});this.refresh=(...t)=>n(this,null,function*(){console.log("Refresh is started!!");let s={resourcePaths:E(t)};yield this.handleRequest("refresh",s,"Refresh is in progress...",7)});this.update=()=>n(this,null,function*(){console.log("Update is started");let t=this.viewPath;if(!t&&i.workspace.rootPath&&(t=i.workspace.rootPath),!t){i.window.showErrorMessage("Invalid view path");return}let e={viewPath:t};yield this.handleRequest("updateview",e,"Update is in progress...",10)});this.remove=(...t)=>n(this,null,function*(){console.log("remove is started!!");let e=yield S("Remove");if(e===void 0)return;let s=E(t);if(e===void 0)return;let r={scmResources:x(e,s)};yield this.handleRequest("remove",r,"Remove is in progress...",8)});this.createView=(t,e,s,o)=>n(this,null,function*(){console.log("view creation is started!!");let r="";o&&(r=o);let a={viewStoragePath:t,viewTag:e,streamSelector:s,sharedCleartextCacheLocation:r};yield this.handleRequest("createview",a,"View Creation is in progress...",9)});this.getVobTags=()=>n(this,null,function*(){console.log("get vobtags is started!!");let t=yield this.invokeAPI("vobtags",null),e;return t!==null&&t.object!==null&&(e=t.object),e});this.mountVobs=(t,e)=>n(this,null,function*(){console.log("Mount VOBs is started!!");let s={viewPath:e,vobTags:t};yield this.invokeAPI("mountvobs",s)});this.setViewConfigSpec=()=>n(this,null,function*(){console.log("setviewconfigspec is started!!");let t={viewPath:"string",configSpec:"string",elementRules:"string",ucmElementRules:"string",loadRules:"string"};yield this.invokeAPI("setviewconfigspec",t)});this.createUCMActivity=(t,e,s)=>n(this,null,function*(){console.log("createUCMActivity is started!!");let o={activityID:t,activityHeader:e,setActivity:s,viewPath:this.viewPath};try{let r=yield this.invokeAPI("createactivity",o);r.responseCode===200?w.window.showInformationMessage("Activity "+t+" has been created"):w.window.showErrorMessage(r.responseMsg)}catch(r){w.window.showErrorMessage(r)}});this.setUCMActivity=t=>n(this,null,function*(){console.log("setUCMActivity is started!!");let e={viewPath:this.viewPath,activityID:t};try{let s=yield this.invokeAPI("setactivity",e);s.responseCode===200?w.window.showInformationMessage("Activity "+t+" has been set"):w.window.showErrorMessage(s.responseMsg)}catch(s){w.window.showErrorMessage(s)}});this.unsetUCMActivity=()=>n(this,null,function*(){console.log("unsetucmactivity is started!!");let t={viewPath:"string"};yield this.invokeAPI("unsetucmactivity",t)});this.removeUCMActivity=()=>n(this,null,function*(){console.log("removeUCMActivity is started!!");let t={streamSelector:"string",activityID:"string"};yield this.invokeAPI("removeucmactivity",t)});this.getActivities=t=>n(this,null,function*(){console.log("getActivities is started!!"),(this.stream||this.stream=="")&&(yield this.getViewStream());let e={stream:this.stream};try{return yield this.invokeAPI("getactivities",e)}catch(s){throw s}});this.getViewStream=()=>n(this,null,function*(){console.log("getViewStream is started!!");let t={viewPath:this.viewPath};try{let e=yield this.invokeAPI("getviewstream",t);e.responseCode===200&&e.stream?this.stream=e.stream:i.window.showErrorMessage(e.responseMsg)}catch(e){i.window.showErrorMessage(e)}});this.getCurrentUCMActivity=t=>n(this,null,function*(){console.log("get Current Activity is started!!");let e="",s={viewPath:t},o=yield this.invokeAPI("currentucmactivity",s);return o!==null&&o.object!==null&&(e=o.object),e});this.filterCheckedoutGroup=t=>{let e=C.resourceStates,s=t.map(o=>({resourceUri:this.createResourceUri(o.resourcePath)}));e=e.filter(o=>!s.find(r=>r.resourceUri.fsPath===o.resourceUri.fsPath)),C.resourceStates=e,this.updateSCMCountBadge()};this.filterHijackGroup=t=>{let e=v.resourceStates,s=t.map(o=>({resourceUri:this.createResourceUri(o.resourcePath)}));e=e.filter(o=>!s.find(r=>r.resourceUri.fsPath===o.resourceUri.fsPath)),v.resourceStates=e,this.updateSCMCountBadge()};this.filterViewPrivateGroup=t=>{let e=m.resourceStates,s=t.map(o=>({resourceUri:this.createResourceUri(o.resourcePath)}));t.map(o=>{let r=o.resourcePath,a=!1;do{let u=(0,Z.dirname)(r);if(u===r){a=!0;break}else if(I(u,m.resourceStates)){let l={resourceUri:this.createResourceUri(u)};s.push(l)}console.log(r),r=u}while(!a)}),e=e.filter(o=>!s.find(r=>r.resourceUri.fsPath===o.resourceUri.fsPath)),m.resourceStates=e,this.updateSCMCountBadge()};this.describeFile=t=>n(this,null,function*(){t&&t.document.uri.toString().startsWith("file:")?K(t.document.fileName).then(e=>{this.describeRealFile(e)}):(P(4),q())});this.describeRealFile=t=>n(this,null,function*(){console.log("describeRealFile is invoked");let e={resourcePaths:[t]},s=this.createRequest("properties",this.getToken(),e),o=yield this.sendRequest(JSON.stringify(s)),r=JSON.parse(o),a={resource:"",versionControlled:!1,checkedOut:!1,hijacked:!1,error:void 0};return r.responseCode===200&&r.resources&&r.resources.length>0&&(a=r.resources[0],yield this.updateResourceState(a)),a});this.describeRealFiles=t=>n(this,null,function*(){console.log("describeRealFiles is invoked");let e={resourcePaths:t},s=yield this.invokeAPI("properties",e);s!==null&&s.object!==null&&s.object.forEach(r=>n(this,null,function*(){yield this.updateResourceState(r)}))});this.updateResourceState=t=>n(this,null,function*(){let e=t.checkedOut,s=t.versionControlled,o=t.hijacked;console.log("isCheckedOut="+e),console.log("isVersionControlled="+s),console.log("isHijack="+o),s?e?P(1):o?P(3):P(0):P(2)});this.createOrSetUCMActivity=()=>n(this,null,function*(){(yield w.window.showQuickPick(["Create a New Activity...","Set an existing Activity..."],{placeHolder:"Set the Activity"}))==="Create a New Activity..."?yield this.createActivity(!0):yield this.setActivity()});this.createActivityCmd=()=>n(this,null,function*(){yield this.createActivity(!1)});this.createActivity=t=>n(this,null,function*(){let e="Enter Activity Headline",s="Activity Headline",o="Enter Activity ID",r="Activity ID",a="",u="";t?(a=yield G(e,s),u=yield G(o,r)):(a=yield i.window.showInputBox({prompt:e,ignoreFocusOut:!0,title:s}),u=yield i.window.showInputBox({prompt:o,ignoreFocusOut:!0,title:r})),a||(a=""),u&&(yield this.createUCMActivity(u,a,!0))});this.setActivity=()=>n(this,null,function*(){yield this.getActivities(this.stream).then(t=>n(this,null,function*(){let e=t==null?void 0:t.activity;if(e){var s=new Array;e.forEach(r=>{s.push(r.activityID+" : "+r.activityHeader)});let o=yield w.window.showQuickPick(s,{placeHolder:"Select the Activity"});if(o){let r=o.split(":",1);yield this.setUCMActivity(r[0].trimEnd())}}}))});this.handleRequest=(t,e,s,o)=>n(this,null,function*(){let r,a={location:i.ProgressLocation.Notification,cancellable:!1};w.window.withProgress(a,u=>n(this,null,function*(){u.report({message:s});try{let l=this.createRequest(t,this.getToken(),e),h=yield this.sendRequest(JSON.stringify(l));if(r=yield JSON.parse(h),console.log("response= "+h),r.responseCode===200||r.responseCode===201||r.responseCode===204)yield this.postOp(o,r);else if(r.responseCode===207)yield this.postOp(o,r),yield this.handleAPIError(r);else{let M=yield this.handleAPIError(r)}}catch(l){let h=l.code,M=l.message;if(yield this.handleAPIError(l))return}}))});this.handleAPIError=t=>n(this,null,function*(){var s;console.log("Handling Error..");let e=!1;if(t)if(t.resourceInfoList){if(t.responseCode===500){let o=t.resourceInfoList;o==null||o.forEach(r=>n(this,null,function*(){let a=r.resourcePath,u=r.error.errorMsg;if(console.error("handleError resource="+a+`
Error=`+u),u!=null&&u.includes("To operate on UCM branch, must be set to an activity and a UCM view")){let l="Create Activity",h="Set Activity";switch(yield i.window.showErrorMessage("Activity is not set in the View. Please create/set an activity",l,h,"Cancel")){case l:yield this.createActivity(!1);break;case h:yield this.setActivity();break}return!0}if(yield this.handleCheckinIdenticalError(a,u))return!0;i.window.showErrorMessage(u||"Error occurred"),e=!0}))}else if(t.responseCode===207){let o=t.resourceInfoList;o==null||o.forEach(r=>n(this,null,function*(){if(r.error){let a=r.resourcePath,u=r.error.errorMsg;e=!0,console.error("HandleAPIError 207 resource="+a+`
Error=`+u),(yield this.handleCheckinIdenticalError(a,u))?e=!0:i.window.showErrorMessage(u||"Error occurred")}}))}}else t.scmResourceProperties?i.window.showErrorMessage(((s=t.scmResourceProperties[0].error)==null?void 0:s.errorMsg)||"Error occurred"):t.responseMsg?(yield this.handleTokenInvalidError(t))===!1&&i.window.showErrorMessage(t.responseMsg):i.window.showErrorMessage(t.toString());return e});this.handleTokenInvalidError=t=>n(this,null,function*(){let e=!1;return t.responseCode===401?(i.commands.executeCommand("setContext","login-criteria",!1),(yield i.window.showErrorMessage(t.responseMsg,"Connect Again".toString(),"Cancel"))==="Connect Again".toString()&&(yield this.login(!1)),!0):e});this.handleCheckinIdenticalError=(t,e)=>n(this,null,function*(){let s=!1,o=this.wsConfiguraiton.get("checkInIdenticalErrorString");return o&&(e==null?void 0:e.includes(o))?(e="The resource ("+t+") is identical to its predecessor and have been left checked out.",i.window.showErrorMessage(e),!0):s});this.postOp=(t,e)=>n(this,null,function*(){yield this.describeFile(i.window.activeTextEditor);let s=[],o="";switch(e.responseCode===207&&e.resourceInfoList?(e.resourceInfoList.forEach(r=>{r.error||s.push(r)}),o="Some "):s=e.resourceInfoList||[],t){case 0:this.filterViewPrivateGroup(s),i.window.showInformationMessage(o+"Resources are added successfully");break;case 1:let r=C.resourceStates;s.forEach(u=>{let l={resourceUri:this.createResourceUri(u.resourcePath)};r.push(l)}),r=[...new Map(r.map(u=>[u.resourceUri.fsPath,u])).values()],C.resourceStates=r,this.filterHijackGroup(s),i.window.showInformationMessage(o+"Resources are Checkedout successfully");break;case 2:this.filterCheckedoutGroup(s),i.window.showInformationMessage(o+"Resources are Checked In successfully");break;case 3:this.filterCheckedoutGroup(s),yield i.commands.executeCommand("workbench.action.files.revert"),i.window.showInformationMessage(o+"Resources are Undo Checkedout successfully");break;case 4:let a=v.resourceStates;s.forEach(u=>{let l={resourceUri:this.createResourceUri(u.resourcePath)};a.push(l)}),a=[...new Map(a.map(u=>[u.resourceUri.fsPath,u])).values()],v.resourceStates=a,this.updateSCMCountBadge(),i.window.showInformationMessage(o+"Resources are Hijacked successfully");break;case 5:this.filterHijackGroup(s),yield i.commands.executeCommand("workbench.action.files.revert"),i.window.showInformationMessage(o+"Resources are Undo Hijacked successfully");break;case 6:i.window.showInformationMessage("Resource is Renamed successfully"),i.commands.executeCommand("workbench.action.closeActiveEditor");break;case 7:e.scmResourceProperties&&(yield this.updateResourceState(e.scmResourceProperties[0])),i.window.showInformationMessage("Resource is Refreshed successfully");break;case 10:yield this.updateResourceStatus(),i.window.showInformationMessage("Repository is updated successfully"),yield i.commands.executeCommand("workbench.files.action.refreshFilesExplorer");break;case 8:i.window.showInformationMessage("Resource is Removed successfully"),i.commands.executeCommand("workbench.action.closeActiveEditor"),yield i.commands.executeCommand("workbench.files.action.refreshFilesExplorer");break}});this.updateSCMCountBadge=()=>{N.count=C.resourceStates.length+v.resourceStates.length+m.resourceStates.length};this.cacheRepoDetails=t=>{var o;let e={viewPath:{}},s=this.globalState.get("RepoCache",e);s[t.toLocaleLowerCase()]={wanServer:this.wanServer,stream:this.stream,user:this.user,token:(o=this.getToken())==null?void 0:o.token},this.globalState.update("RepoCache",s)};this.updateTokenInRepoCache=()=>{var e;let t=this.globalState.get("RepoCache");if(t&&this.viewPath){let s=t[this.viewPath.toLocaleLowerCase()];s&&(s.token=(e=this.getToken())==null?void 0:e.token,t[this.viewPath.toLocaleLowerCase()]=s,this.globalState.update("RepoCache",t))}};this.globalState=t,this.wsConfiguraiton=e,this.disposables=[],z(),this.initSCM(),this.initCommands()}createResourceUri(t){return i.Uri.file(t)}setStream(t){this.stream=t}setWanServer(t){this.wanServer=t}setUser(t){this.user=t}setApiToken(t){this.apiToken=t}getWanServer(){return this.wanServer}getUser(){return this.user}setViewPath(t){this.viewPath=t}getStream(){return this.stream}getDisposables(){return this.disposables}checkoutResources(t){return n(this,null,function*(){let e=yield S("Checkout");if(e===void 0)return;let s=x(e,t),o=this.wsConfiguraiton.get("reservedCheckout");o===void 0&&(o=!1);let r={scmResources:s,reserveCheckout:o};yield this.handleRequest("checkout",r,"Checkout is in progress...",1)})}getViewType(t){return n(this,null,function*(){if(console.log("getViewType is started!!"),!t){console.log("path is null");return}let e={viewPath:t},s=this.createRequest("getviewtype",this.getToken(),e),o=yield this.sendRequest(JSON.stringify(s)),r=JSON.parse(o);console.log(r),r.responseCode===200&&r.viewType&&(this.viewType=r.viewType)})}sendRequest(t){return n(this,null,function*(){return new Promise((e,s)=>{let o="",r;this.platform==="win32"?r=(0,j.spawn)($):r=(0,j.spawn)(Q),r.stdin.write(t),r.stdin.end(),r.stdout.on("data",a=>{console.log(a.toString()),o=a.toString()}),r.stderr.on("data",a=>{console.error(a.toString()),s(a.toString())}),r.on("exit",a=>{a!==0?s(`Process exited with code ${a}`):e(o)})})})}createRequest(t,e,s){return{operationName:t,communication:e,operationArguments:s}}};var ee=require("os");var g;function ke(c){return n(this,null,function*(){console.log('Congratulations, your extension "clearcase" is now active');let t=c.globalState,e=k.workspace.getConfiguration("clearcase");g=new F(t,e),g.platform=(0,ee.platform)();let s=k.workspace.workspaceFolders;if(s){let o=s[0].uri.fsPath;g.setViewPath(o);let r=c.globalState.get("RepoCache");if(r&&o){let a=r[o.toLocaleLowerCase()];a&&(g.setViewPath(o),a.stream&&g.setStream(a.stream),a.wanServer&&g.setWanServer(a.wanServer),a.user&&g.setUser(a.user),a.token&&g.setApiToken(a.token),yield g.describeFile(k.window.activeTextEditor),yield g.updateResourceStatus())}try{yield g.getViewType(o)}catch(a){console.log(a)}}g.viewType==="DYNAMIC"?k.commands.executeCommand("setContext","dynamicView",!0):g.viewType==="SNAPSHOT"&&k.commands.executeCommand("setContext","snapshotView",!0)})}function ye(){console.log("deactivating")}0&&(module.exports={activate,deactivate});
